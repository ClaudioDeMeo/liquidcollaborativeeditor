<!--
@license
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/sortable-list/sortable-list.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<link rel="import" href="base/utils-behavior.html">
<link rel="import" href="room/room-media.html">
<link rel="import" href="local-video-player.html">
<link rel="import" href="remote-video-player.html">

<dom-module id="work-group">
  <template>
    <style include="shared-styles">

      app-header-layout {
        position: inherit;
      }

      app-header {
        background: #fff;
        height: -webkit-fill-available;
      }

      app-toolbar {
        color: var(--primary-text-color);
        background-color: var(--primary-background-color);
      }

      paper-item {
        margin: 2px;
      }

      .list {
        width: 100%;
        height: 100%;
        overflow-y: auto;
      }

      .publisher-button-add{
        position: absolute;
        top:0;
        width: 100%;
        height: 100%;
        color: var(--primary-text-color);
        background-color: #ddd;
        border: dashed 4px lightgray;
        font-size: 48px;
        padding: 0;
        margin: 0;
      }

      .containerLocal{
        position: relative;
        /*margin-top: 0.5em;*/
        margin-left: 0.5em;
        width: fit-content;
        min-width: 120px;
        min-height: 90px;
      }

      .remote {
        margin-right: 0.5em;
      }

      hr{
        margin: 5px;
      }

    </style>
    <!-- WORK-GROUP DEFINE -->
    <app-header-layout has-scrolling-region>
      <app-header fixed slot="header">
        <app-toolbar>Workgroup ({{room}})</app-toolbar>
        <!-- VIDEO LOCAL -->
        <div class="layout vertical center center-justified wrap" hidden="{{!videoroom}}">
          <b>{{username}}</b>
          <div class="containerLocal">
            <local-video-player publisher="{{developer}}"></local-video-player>
            <paper-icon-button
              icon="add"
              class="publisher-button-add"
              hidden="{{developer.stream}}"
              on-tap="_onAddLocalPublisher">
            </paper-icon-button>
          </div>
        </div>
        <hr>
        <!-- PARTICIPANT LIST AND VIDEO -->
        <sortable-list class="list" dragging="{{dragging}}" sortable=".item">
          <template is="dom-repeat" items="[[developers]]">
            <paper-item class="remote-item item">
              <div class="layout horizontal center wrap">
                <remote-video-player class="remote" publisher="[[item]]"></remote-video-player>
                <b>[[item.display]]</b>
              </div>
            </paper-item>
          </template>
        </sortable-list>
      </app-header>
    </app-header-layout>
  </template>

  <script>

    String.prototype.hashCode = function(){
      var hash = 0, i, chr;
      if (this.length === 0) return hash;
      for(i = 0; i < this.length; i++){
        chr = this.charCodeAt(i);
        hash = (hash << 7) + chr;
      }
      hash = hash & 0x007FFFFF;
      return hash;
    };

    Polymer({
      is:'work-group',
      behaviors: [
        Polymer.UtilsBehavior,
      ],
      properties: {

      },

      _onAddLocalPublisher: function(){
        var self = this;
        self.log('onAddLocalPublisher');
        //
        var el = MediaDialog(function(err, result){
          self.log('MediaDialog', err, result);
          if(!err){
            var publisher = result.detail;
            publisher.handle = null;
            publisher.stream = null;
            // publisher.joined = false;

            self.set('developer', publisher);
            self.publish(self.developer);

            // self.push('developer', publisher);
            //
            // self.publishCallback(publisher, self.developer.length-1);
          }
        });
        // el.room = self.room;
      },

      publish: function(publisher){
        var self = this;
        self.log('publish', publisher);
        self.videoroom.createOffer({
          media: {
            video: publisher.video,
            audio: publisher.audio,
            videoSend: publisher.videoSend,
            audioSend: publisher.audioSend,
          },
          success: function(jsep){
            self.videoroom.send({
              message: {
                request: "configure",
                // room: self.room,
                // ptype: 'publisher',
                // display: self.username,
                // pin: self.password,
                video: publisher.videoSend,
                audio: publisher.audioSend,
                bitrate: publisher.bitrate,
                videoRecv: false,
                audioRecv: false,
              },
              jsep: jsep
            });
            self.log("publish request sent");
          },
          error: function(error){
            self.log("publish error:", error);
          }
        });
      },

    });
  </script>
</dom-module>
